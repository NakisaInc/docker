# set up cron service
sudo apt-get install cron
sudo service cron start

# download backup scripts
sudo mkdir /nakisa/app
wget -O - https://raw.githubusercontent.com/NakisaInc/docker/Hanelly-3.0/backup.sh  > ~/backup.sh
sudo mv ~/backup.sh /nakisa/app/backup.sh

# Ensure Apache is deployed and Apache /nakisa/app-volumes/apache-* directories exist
# See: https://nakisa.atlassian.net/wiki/spaces/CSOL/pages/7357013/Apache+SSL+Termination

# in the /nakisa/app/backup.sh script set the following variables to the directories which need to be copied
# you will need to supply the full absolute path of the directory - the backup.sh file will have defaults pre-filled
NAK_BACKUP_HANELLY_DIRECTORY=/...
NAK_BACKUP_TOMCAT_LOGS_DIRECTORY=/...
NAK_BACKUP_MYSQL_DIRECTORY=/...
NAK_BACKUP_APACHE_SHIB_DIRECTORY=/nakisa/app-volumes/apache-shib
NAK_BACKUP_APACHE_CONF_DIRECTORY=/nakisa/app-volumes/apache-conf
# modify the limits on the number of daily, weekly and monthly backups to keep as needed or keep the defaults
NUM_DAILY_BACKUPS_TO_KEEP=10
NUM_WEEKLY_BACKUPS_TO_KEEP=5
NUM_MONTHLY_BACKUPS_TO_KEEP=13
# set userid and password for mySQL DB backup
MYSQL_USERID=
MYSQL_PASSWORD=

# manually execute each backup script to ensure it is working correctly and backing up the required directories
sudo chmod +x /nakisa/app/backup.sh
. /nakisa/app/backup.sh DailyDBOnly
. /nakisa/app/backup.sh WeeklyFull
. /nakisa/app/backup.sh MonthlyFull

# check for any error messages when running the above in case incorrect directories were specified
# check the following backup logs in /nakisa/app/ to ensure correct log capture and copied directory sizings are similar to original sizings:
#    /nakisa/backupDailyDBOnlyLog, /nakisa/backupWeeklyFullLog and /nakisa/backupMonthlyFullLog
# check the copied content in /nakisa/backupDailyDBOnly, /nakisa/backupWeeklyFull and /nakisa/backupMonthlyFull directories
# as well as the existance of tar files in /nakisa_backup
# mount the /nakisa_backup directory because the backup scripts unmount it when they finish running (for snapshot purposes)
sudo mount /dev/xvdd1

# setup cron job to run daily, weekly and monthly backup scripts
sudo crontab -e

# add the following lines to the crontab file and save it - the jobs are now scheduled
# eg. Coty Prod: 9pm PST or 4am UTC (next day)
# min hour dayOfMonth month dayOfWeek
  0   5    1          *     *             /nakisa/app/backup.sh MonthlyFull    # Monthly Full backup @10pm PST: 1st of the month
  0   4    *          *     0             /nakisa/app/backup.sh WeeklyFull     # Weekly  Full backup  @9pm PST: Sat
  0   4    *          *     1,2,3,4,5,6   /nakisa/app/backup.sh DailyDBOnly    # Daily   Data backup  @9pm PST: Sun-Fri
#  0,15,30,45               *    *          *     *   /nakisa/app/backup.sh MonthlyFull    # Monthly test every 15 minutes
#  5,10,20,25,35,40,50,55   *    *          *     *   /nakisa/app/backup.sh WeeklyFull     # Weekly  test every  5 minutes
#  *                        *    *          *     *   /nakisa/app/backup.sh DailyDBOnly    # Daily   test every  1 minutes

sudo crontab -l  

 mkdir /nakisa/backup-restore
 tar -xvf /nakisa_backup/<backup_filename>.tar.gz -C /nakisa/backup-restore --strip-components=2

 tar -xvf /nakisa_backup/backupWeeklyFull_2017.09Sep.10_03-05-35.220528478.tar.gz -C /nakisa/backup-restore --strip-components=2

tar -xvf ~/t2.tar.gz -C /


